"""
Module for testing of vector text representation.
=================================================

Classes:
----------
TestYandexEmbeddings:
    \n\ttest_getModelUri
    \n\ttest_embed_document
    \n\ttest_embed_documents
    \n\ttest_embed_query

Dependencies:
-------------
django
\ntyping

"""


from typing import cast

from django.test.testcases import TestCase

from akcent_graph.apps.secret_settings.models import YGPTSettings
from akcent_graph.utils.clients.gpt.yandex_chain.YandexGPTEmbeddings import YandexEmbeddings


class TestYandexEmbeddings(TestCase):
    """
    Tests for akcent_graph.utils.clients.gpt.yandex_chain.YandexGPT_errors.py
    ======================================================================

    Methods:
    --------
    \n\tsetUp
    \n\ttest_getModelUri
    \n\ttest_embed_document
    \n\ttest_embed_documents
    \n\ttest_embed_query

    """

    def setUp(self) -> None:
        ygpt_settings = YGPTSettings.objects.first()
        if ygpt_settings:
            self.api_key = cast(str, ygpt_settings.api_key)
            self.folder_id = cast(str, ygpt_settings.folder_id)
        self.document = """
        ПРОТОКОЛ: 2Д3001 — Ректороманоскопия Дата проведения исследования (консультации): 19.11.2016

        Дата формирования заключительного протокола: 19.11.2016 Направительный диагноз:

        обследование (в анамнезе цитомегаловирусная инфекция с поражением слизистой сигмовидной кишки)

        Прием больного:

        Первичный
        Аппарат: ФКС:Видеоколоноскоп OLYMPUS PCF- 140L (2811254)

        Объективный статус:
        Осмотр области ануса: кожа вокруг ануса не изменена. Геморроидальные узлы увеличены внутрен- ние,
        безболезненные, мягкие.
        Пальцевое исследование прямой кишки: боли при исследовании нет.
        Для анестезии анального канала использован Катеджель 6,0.
        Тонус сфинктера сохранен. Анальный канал свободно проходим. Новообразования в анальном канале
        и прямой кишке: не выявлено.

        Описание:

        Добровольное информированное согласие получено.

        Толстая кишка осмотрена до средней трети сигмовидной кишки, на 50 см от ануса. Просвет осмотренной
        части ободочной кишки хорошо расправляется воздухом. Для уменьшения вздутия использован эспуми- зан
        10,0 в разведении дистиллированной водой. Тонус кишечной стенки не снижен, перистальтика про- слеживается.
        Гаустрация правильная. Форма просвета соответствует отделу кишки, cлизистая кишки на осмотренном протяжении
        розовая. Сосудистый рисунок просматривается хорошо.

        Подготовка:

        No 3 хорошая.

        Заключение:

        Внутренний геморрой вне обострения.

        МКБ:

        K64.0
        Врач-эндоскопист, врач высшей категории, Хмельницкая В.А.

        """

        self.answer_document = [
            -0.03570556640625,
            -0.01486968994140625,
            0.08526611328125,
            -0.0963134765625,
            -0.09014892578125,
            0.04052734375,
            -0.01238250732421875,
            -0.0679931640625,
            0.0927734375,
            -0.11749267578125,
            0.187255859375,
            0.06353759765625,
            0.0655517578125,
            0.023223876953125,
            -0.031646728515625,
            0.109619140625,
            0.0190887451171875,
            -0.06597900390625,
            0.035919189453125,
            0.1644287109375,
            0.07598876953125,
            -0.0133209228515625,
            0.007427215576171875,
            0.004970550537109375,
            -0.061920166015625,
            0.11175537109375,
            -0.0791015625,
            -0.0570068359375,
            0.1031494140625,
            -0.09844970703125,
            -0.11773681640625,
            0.034149169921875,
            -0.08929443359375,
            0.01148223876953125,
            -0.033172607421875,
            0.013671875,
            0.052337646484375,
            -0.012786865234375,
            0.01184844970703125,
            0.044464111328125,
            0.005290985107421875,
            0.025848388671875,
            -0.03692626953125,
            0.0706787109375,
            0.031829833984375,
            0.0311737060546875,
            -0.07525634765625,
            0.05242919921875,
            -0.020843505859375,
            0.035675048828125,
            -0.06719970703125,
            0.140869140625,
            0.0120391845703125,
            0.0748291015625,
            0.11285400390625,
            0.1571044921875,
            -0.020416259765625,
            0.06787109375,
            0.0303955078125,
            0.08282470703125,
            0.0810546875,
            0.00319671630859375,
            0.05621337890625,
            0.02044677734375,
            0.00728607177734375,
            -0.05096435546875,
            0.053070068359375,
            -0.0670166015625,
            0.07806396484375,
            -0.009002685546875,
            -0.054779052734375,
            -0.07220458984375,
            0.07781982421875,
            0.0616455078125,
            -0.01088714599609375,
            0.07147216796875,
            0.06866455078125,
            -0.0257415771484375,
            0.0232696533203125,
            -0.10552978515625,
            -0.02392578125,
            0.1004638671875,
            0.04815673828125,
            -0.046905517578125,
            -0.032684326171875,
            -0.0203399658203125,
            -0.0029850006103515625,
            0.11297607421875,
            -0.007488250732421875,
            0.0156707763671875,
            0.006679534912109375,
            0.06829833984375,
            -0.0111083984375,
            -0.1044921875,
            0.00881195068359375,
            0.0733642578125,
            0.07489013671875,
            -0.034271240234375,
            -0.031097412109375,
            0.057464599609375,
            0.036376953125,
            -0.021026611328125,
            0.003696441650390625,
            0.007232666015625,
            0.0230560302734375,
            -0.0129241943359375,
            -0.07598876953125,
            -0.02490234375,
            0.044342041015625,
            -0.043365478515625,
            -0.05059814453125,
            -0.1317138671875,
            0.1029052734375,
            0.037933349609375,
            -0.03033447265625,
            -0.1070556640625,
            0.01947021484375,
            0.063232421875,
            0.0164794921875,
            -0.032073974609375,
            -0.09039306640625,
            0.0260009765625,
            -0.0218353271484375,
            -0.04443359375,
            0.08795166015625,
            -0.0703125,
            0.0189971923828125,
            0.01739501953125,
            -0.0018987655639648438,
            0.016754150390625,
            -0.05767822265625,
            -0.01293182373046875,
            -0.052459716796875,
            -0.02105712890625,
            0.12109375,
            0.049346923828125,
            0.043548583984375,
            0.04656982421875,
            0.0158233642578125,
            -0.02874755859375,
            -0.028533935546875,
            0.0275726318359375,
            0.040985107421875,
            -0.114501953125,
            -0.041778564453125,
            -0.042388916015625,
            -0.00925445556640625,
            -0.09521484375,
            0.00510406494140625,
            0.095703125,
            0.0236053466796875,
            0.0238037109375,
            0.062164306640625,
            0.1063232421875,
            -0.059295654296875,
            -0.027191162109375,
            0.0272369384765625,
            0.034942626953125,
            0.0260162353515625,
            0.058013916015625,
            -0.09039306640625,
            0.0155487060546875,
            -0.149658203125,
            0.11871337890625,
            -0.043975830078125,
            0.0249786376953125,
            0.058319091796875,
            -0.050445556640625,
            -0.004550933837890625,
            -0.08013916015625,
            -0.03570556640625,
            -0.11444091796875,
            0.0404052734375,
            0.009124755859375,
            -0.018341064453125,
            0.0233306884765625,
            -0.054046630859375,
            -0.007381439208984375,
            0.022491455078125,
            -0.1156005859375,
            0.1630859375,
            -0.01102447509765625,
            0.017791748046875,
            0.00659942626953125,
            0.040618896484375,
            0.0231781005859375,
            -0.117431640625,
            -0.0318603515625,
            -0.0341796875,
            -0.0033664703369140625,
            0.06256103515625,
            0.059783935546875,
            -0.05584716796875,
            -0.02679443359375,
            0.041046142578125,
            0.07281494140625,
            0.07110595703125,
            0.011322021484375,
            -0.04498291015625,
            -0.10321044921875,
            0.1343994140625,
            0.06329345703125,
            0.0190582275390625,
            -0.05230712890625,
            0.00646209716796875,
            -0.05908203125,
            -0.026580810546875,
            0.0506591796875,
            0.039825439453125,
            0.07965087890625,
            0.040679931640625,
            0.017547607421875,
            0.0028972625732421875,
            0.060028076171875,
            -0.019775390625,
            0.047637939453125,
            0.042877197265625,
            0.07159423828125,
            0.056182861328125,
            0.020233154296875,
            -0.0777587890625,
            0.036346435546875,
            -0.0478515625,
            0.0272369384765625,
            -0.1302490234375,
            -0.01361083984375,
            0.06304931640625,
            -0.0123138427734375,
            -0.03271484375,
            0.0220947265625,
            -0.0159149169921875,
            -0.140625,
            0.055999755859375,
            0.02728271484375,
            -0.06622314453125,
            -0.035980224609375,
            -0.0171356201171875,
            -0.03118896484375,
            -0.14111328125,
            -0.0506591796875,
            -0.08172607421875,
            -0.0180816650390625,
            -0.012786865234375,
            -0.02642822265625,
            0.032989501953125,
            -0.010589599609375,
            0.062744140625,
            -0.0010385513305664062,
            -0.07110595703125,
            -0.0204925537109375,
            0.0216064453125,
            -0.07574462890625,
            0.08575439453125,
            0.016693115234375,
            -0.06744384765625,
            0.08050537109375,
        ]

    def test_getModelUri(self) -> None:
        embedder = YandexEmbeddings(
            sleep_interval=0.11,
            folder_id=self.folder_id,
            api_key=self.api_key,
        )

        answer_query = 'emb://b1g754bjfp28oj9sinrf/text-search-query/latest'
        answer_document = 'emb://b1g754bjfp28oj9sinrf/text-search-doc/latest'

        self.assertEqual(
            answer_query,
            embedder._getModelUri(),
        )
        self.assertEqual(
            answer_document,
            embedder._getModelUri(is_document=True),
        )

    def test_embed_document(self) -> None:
        embedder = YandexEmbeddings(
            sleep_interval=0.11,
            folder_id=self.folder_id,
            api_key=self.api_key,
        )
        self.assertEqual(
            self.answer_document,
            embedder.embed_document(self.document),
        )

    def test_embed_documents(self) -> None:
        embedder = YandexEmbeddings(
            sleep_interval=0.11,
            folder_id=self.folder_id,
            api_key=self.api_key,
        )
        documents = [self.document, self.document]
        answer_documents = [self.answer_document, self.answer_document]

        self.assertEqual(
            answer_documents,
            embedder.embed_documents(documents),
        )

    def test_embed_query(self) -> None:
        embedder = YandexEmbeddings(
            sleep_interval=0.11,
            folder_id=self.folder_id,
            api_key=self.api_key,
        )
        query = 'врач-невролог'
        answer_query = [
            -0.0489501953125,
            -0.0753173828125,
            -0.10064697265625,
            -0.00464630126953125,
            -0.0036773681640625,
            0.036376953125,
            0.08831787109375,
            -0.03424072265625,
            0.08099365234375,
            -0.036224365234375,
            -0.0155181884765625,
            -0.0094757080078125,
            -0.0560302734375,
            0.06524658203125,
            0.006435394287109375,
            0.1055908203125,
            0.0125579833984375,
            -0.0170135498046875,
            -0.0102081298828125,
            0.030517578125,
            0.01079559326171875,
            0.05804443359375,
            0.08709716796875,
            0.0177001953125,
            -0.004810333251953125,
            0.07928466796875,
            0.0184478759765625,
            0.01824951171875,
            0.0136260986328125,
            -0.10833740234375,
            0.06622314453125,
            -0.00495147705078125,
            -0.11895751953125,
            0.05670166015625,
            -0.064208984375,
            0.057769775390625,
            -0.023681640625,
            -0.03594970703125,
            0.0002932548522949219,
            0.097412109375,
            -0.10357666015625,
            -0.021453857421875,
            0.0859375,
            0.020538330078125,
            0.035675048828125,
            0.02886962890625,
            -0.0452880859375,
            0.05499267578125,
            0.049224853515625,
            -0.009063720703125,
            -0.049591064453125,
            -0.010986328125,
            -0.167236328125,
            0.0322265625,
            -0.057403564453125,
            0.08941650390625,
            -0.036651611328125,
            0.0972900390625,
            0.047698974609375,
            0.10296630859375,
            0.1070556640625,
            0.03643798828125,
            -0.024261474609375,
            0.07940673828125,
            -0.0439453125,
            0.08074951171875,
            0.07891845703125,
            -0.08538818359375,
            -0.1822509765625,
            -0.016448974609375,
            -0.045654296875,
            -0.0278778076171875,
            0.06866455078125,
            0.0860595703125,
            0.045440673828125,
            0.054168701171875,
            0.050567626953125,
            0.03314208984375,
            0.12432861328125,
            0.004787445068359375,
            -0.01264190673828125,
            0.01416015625,
            0.006862640380859375,
            0.052947998046875,
            -0.003772735595703125,
            0.09332275390625,
            0.016204833984375,
            0.11187744140625,
            0.07275390625,
            -0.005878448486328125,
            0.04815673828125,
            -0.0182952880859375,
            -0.0280609130859375,
            -0.0154266357421875,
            0.08697509765625,
            -0.1334228515625,
            -0.03204345703125,
            -0.03448486328125,
            -0.01163482666015625,
            0.0740966796875,
            -0.0419921875,
            -0.006359100341796875,
            0.0302276611328125,
            -0.160888671875,
            -0.038909912109375,
            0.004940032958984375,
            -0.11505126953125,
            0.0214996337890625,
            0.024749755859375,
            0.037445068359375,
            -0.036651611328125,
            -0.004528045654296875,
            -0.0236663818359375,
            0.0285797119140625,
            -0.0338134765625,
            0.0164794921875,
            -0.005039215087890625,
            0.1094970703125,
            -0.0635986328125,
            -0.04071044921875,
            -0.048919677734375,
            0.07073974609375,
            0.0233306884765625,
            -0.034576416015625,
            0.024871826171875,
            -0.0014247894287109375,
            -0.08758544921875,
            -0.014312744140625,
            0.035675048828125,
            -0.0450439453125,
            0.056976318359375,
            0.1219482421875,
            0.028472900390625,
            -0.0080413818359375,
            0.0196533203125,
            -0.09490966796875,
            -0.0176849365234375,
            -0.0146636962890625,
            -0.004726409912109375,
            0.09381103515625,
            0.0162811279296875,
            0.043670654296875,
            0.11492919921875,
            0.0885009765625,
            -0.08758544921875,
            -0.0213165283203125,
            -0.07061767578125,
            -0.0237884521484375,
            -0.09149169921875,
            0.029693603515625,
            -0.01209259033203125,
            -0.03900146484375,
            -0.0278778076171875,
            -0.048431396484375,
            -0.0322265625,
            -0.112548828125,
            -0.041900634765625,
            -0.032928466796875,
            0.07073974609375,
            0.14306640625,
            0.053070068359375,
            -0.0244140625,
            0.0228118896484375,
            -0.07757568359375,
            -0.0037555694580078125,
            0.047271728515625,
            -0.021087646484375,
            0.04144287109375,
            0.083251953125,
            -0.045135498046875,
            -0.07257080078125,
            -0.073486328125,
            0.0849609375,
            -0.0186614990234375,
            0.00490570068359375,
            -0.0526123046875,
            0.02532958984375,
            0.0433349609375,
            0.061859130859375,
            0.0328369140625,
            0.01415252685546875,
            0.00414276123046875,
            -0.03546142578125,
            0.042633056640625,
            -0.002582550048828125,
            -0.039947509765625,
            -0.1419677734375,
            0.0078582763671875,
            0.01174163818359375,
            0.05682373046875,
            0.0025730133056640625,
            0.032958984375,
            -0.0653076171875,
            -0.0836181640625,
            0.07647705078125,
            -0.0697021484375,
            0.038818359375,
            0.016082763671875,
            0.07391357421875,
            -0.111572265625,
            -0.1143798828125,
            0.0242156982421875,
            -0.0390625,
            0.08184814453125,
            0.01218414306640625,
            0.035491943359375,
            0.0075531005859375,
            0.0003581047058105469,
            0.1346435546875,
            -0.009552001953125,
            0.06256103515625,
            0.0245208740234375,
            -0.005435943603515625,
            -0.031982421875,
            -0.03912353515625,
            -0.013702392578125,
            0.00450897216796875,
            -0.0313720703125,
            -0.0103302001953125,
            0.0721435546875,
            -0.0301055908203125,
            0.12042236328125,
            -0.1099853515625,
            -0.0230560302734375,
            -0.056610107421875,
            -0.04052734375,
            0.039794921875,
            0.1094970703125,
            -0.044342041015625,
            0.029693603515625,
            -0.0238189697265625,
            -0.11102294921875,
            -0.06671142578125,
            0.11865234375,
            -0.09210205078125,
            0.021240234375,
            0.08795166015625,
            -0.09295654296875,
            0.03460693359375,
            0.06317138671875,
            0.024993896484375,
            0.092041015625,
            -0.09478759765625,
            0.1231689453125,
            -0.01800537109375,
            -0.09100341796875,
            -0.0328369140625,
            0.1187744140625,
            -0.054779052734375,
            0.08941650390625,
            -0.04998779296875,
            0.0015344619750976562,
            -0.05523681640625,
            -0.049224853515625,
            -0.00472259521484375,
            -0.10565185546875,
        ]

        self.assertEqual(
            answer_query,
            embedder.embed_query(query.lower()),
        )
